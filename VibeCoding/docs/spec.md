# 英语学习 Web 系统（类 LingQ）需求与架构规划

## 一、产品目标

构建一个面向英语学习者的 Web 系统，支持从 PDF、Word 等文档中导入内容，在阅读过程中快速查词、收藏单词，并围绕单词进行造句、纠错、背诵和测试，结合艾宾浩斯遗忘曲线进行高效复习，并支持对文章、段落和句子进行听力训练。

---

## 二、按 Phase 拆分的交付计划

> 目标：把 V1 能力按“可交付、可验收”的阶段拆分，便于你按里程碑推进。

### Phase 0：项目骨架与基础设施

- **目标**
  - 搭建可运行的前后端工程骨架与基础能力，为后续迭代提供稳定底座。

- **范围（做什么）**
  - 前端：初始化 Next.js + TS + Tailwind（可选 shadcn/ui）。
  - 后端：初始化 NestJS + TS。
  - 数据库：PostgreSQL 连接打通，Prisma 初始化。
  - 基础工程：环境变量、日志、统一错误返回结构。

- **交付物**
  - 可启动的前端与后端工程。
  - 一个健康检查 API（如 `/health`）。
  - 基础数据库迁移脚手架。

- **验收标准**
  - 本地一键启动后，前端能访问后端健康检查接口。
  - Prisma 能成功生成并连接数据库。

---

### Phase 1：文档导入与解析（PDF / Word / TXT / 图片 / 手动输入 -> 段落/句子）

- **目标**
  - 用户可上传 PDF/DOCX/TXT/图片，或直接粘贴文本内容，系统能解析并存成结构化内容。

- **范围（做什么）**
  - 文件上传：支持 PDF、Word (.docx)、纯文本 (.txt) 和 图片 (JPG/PNG)。
  - 多图片 OCR：支持批量上传图片，通过 OCR 提取文本。
  - AI 合并去重：针对多张图片（如截图）解析出的可能重复或不连贯的文本，调用 DeepSeek 模型进行智能去重、修正并合并为完整文章。
  - 手动输入：提供文本框，支持用户直接粘贴长篇内容。
  - 内容解析：
    - DOCX：提取文本。
    - PDF：使用 `pdfjs-dist` 提取文本。
    - TXT：直接读取。
    - 图片：使用 OCR 库（如 `tesseract.js`，支持中英文混合识别）提取文本。
    - 手动输入：直接接收字符串。
  - 分段/分句：将文本切为段落与句子并落库。
  - 文档列表：展示用户已导入的文档。

- **交付物**
  - `documents`、`document_paragraphs`、`document_sentences` 基础表。
  - 文档上传 API、解析入库流程。
  - 前端文档列表页 + 上传页。

- **验收标准**
  - 上传一个 PDF/DOCX 后：
    - 文档出现在列表里。
    - 进入详情能看到按段/按句的结构化文本。

---

### Phase 2：阅读器（分词渲染）+ 查词 + 生词收藏

- **目标**
  - 提供核心阅读闭环：阅读文章 -> 点击查词 -> 加入生词本 -> 文章内高亮。

- **范围（做什么）**
  - 阅读器页面：按句渲染，支持单词点击。
  - 词典查询：后端封装词典查询（外部 API + 缓存占位）。
  - 生词本：
    - 收藏/取消收藏。
    - 单词状态：新词/学习中/已掌握。
  - 高亮：根据 `user_words` 状态高亮文档内命中的词。

- **交付物**
  - `user_words` 表与相关 API（增删改查）。
  - 阅读器页面 + 词卡组件。
  - 生词本列表页（最简可用）。

- **验收标准**
  - 在阅读器点击单词能弹词卡并显示释义。
  - 点击“收藏”后生词本能看到该词。
  - 同一篇文章中该词被高亮显示。

---

### Phase 3：SRS / 艾宾浩斯复习（背词闭环）

- **目标**
  - 生词可进入复习队列，每天生成待复习列表并可完成复习。

- **范围（做什么）**
  - 复习调度：为每个 `user_word` 维护 `next_review_at` 等字段。
  - 复习 API：
    - 获取今日待复习单词。
    - 提交复习结果（正确/错误/自评等级）。
  - 复习页面：卡片式流程。

- **交付物**
  - `srs_reviews` 表。
  - SRS 计算逻辑（可用简化的间隔重复实现，后续可替换为更完整 SM-2）。
  - 复习 UI。

- **验收标准**
  - 生词进入复习队列后，次日/按规则能出现在“今日复习”。
  - 提交结果后，单词的 `next_review_at` 会变化。

---

### Phase 4：TTS 听读（句子/段落/文章朗读）

- **目标**
  - 对导入文章实现可控的听读训练。

- **范围（做什么）**
  - TTS API：输入文本返回音频 URL（可缓存）。
  - 阅读器播放：
    - 单句播放。
    - 逐句播放（队列）。
  - 音频缓存策略：按 `text_hash + voice + speed` 复用。

- **交付物**
  - `tts_assets` 表。
  - TTS 服务封装（可先接一个云厂商或 Edge TTS）。
  - 前端播放器组件。

- **验收标准**
  - 阅读器中点击某句“播放”能听到声音。
  - 重复播放同一句不会重复生成（有缓存命中）。

---

### Phase 5：AI 场景造句 + 纠错 + 表达建议（写作闭环）

- **目标**
  - 用户围绕目标词在指定场景下造句，系统能评价与纠错并提供更地道表达。

- **范围（做什么）**
  - 造句任务：选词 + 选场景 + 输入句子。
  - AI 评估：输出结构化 JSON：
    - 是否正确、错误点、修正版、更地道版本、简要解释。
  - 记录存档：可回看历史。

- **交付物**
  - `ai_sentence_tasks`、`ai_sentence_results` 表。
  - AI 调用封装与 prompt 模板（严格 JSON 输出）。
  - 前端造句页/弹窗。

- **验收标准**
  - 输入一句含目标词的句子后：
    - 返回语法判断与修正版。
    - 给出至少 1 条更自然的替代表达。

---

### Phase 6：测试系统（从文章自动出题：填空/组句）

- **目标**
  - 从导入文章中自动生成练习题，评估学习效果。

- **范围（做什么）**
  - 自动出题：
    - 句子填空（挖空目标词）。
    - 关键词组句（可配合 AI 判分）。
  - 做题记录：保存结果，可用于影响 SRS 熟练度（可选）。

- **交付物**
  - `test_exercises`、`test_results` 表。
  - 生成题目 API + 做题 API。
  - 前端测试页面。

- **验收标准**
  - 从指定文档生成一组题并可完成作答。
  - 做题结果可回看。

---

## 三、核心功能范围（V1）

### 1. 文档导入与解析

- 支持上传文档：
  - PDF
  - Word（.docx）
- 将文档解析为结构化内容：
  - 文档 → 段落 → 句子
- 保存文档元数据：
  - 标题、来源、导入时间、作者（可选）
- 为后续能力提供基础：
  - 阅读（按句展示）
  - TTS（按句播放）
  - 练习（从句子挖空、造句）

### 2. 阅读器：查词 + 收藏（生词本）

- 文本阅读界面：
  - 显示解析后的文章/段落/句子
  - 支持基础排版（字号、行距等后续可扩展）
- 单词交互：
  - 单词可点击
  - 点击展示词卡（弹窗/侧栏）
    - 单词拼写
    - 音标
    - 释义（中英可选）
    - 示例句（可选）
- 收藏/生词本：
  - 将单词加入生词本
  - 为每个用户记录单词状态：新词、学习中、已掌握
- 文章内高亮：
  - 根据用户单词状态，为单词着色（如：新词红色、学习中黄色、已掌握灰色）

### 3. 单词造句（指定场景）+ 验证与纠错

- 用户从文章或生词本中选择一个单词或短语
- 选择或输入一个“场景”：
  - 如：面试、旅游、商务邮件、学术写作、日常对话等
- 造句流程：
  1. 用户基于指定场景自己写一句英文。
  2. 系统调用 AI 服务：
     - 判断句子语法是否正确。
     - 判断是否恰当使用了该目标单词。
     - 若有问题，给出：
       - 修改后的正确版本
       - 更自然/地道的表达建议
       - 问题说明（例如：时态错误、搭配不当、用词不符合场景等）
  3. 将造句记录存档，供用户回顾。

### 4. 艾宾浩斯/SRS 背单词

- 生词本中的单词加入 SRS（间隔重复）系统：
  - 为每个用户-单词维护：
    - 熟练度/记忆等级
    - 上次复习时间
    - 下一次复习时间
- 复习流程：
  - 系统每天生成“今日待复习单词列表”
  - 提供简单题型：
    - 看词想义 / 看义选词
    - （后期）拼写、听音写词
  - 记录每次复习的结果（正确/错误、自信程度）
  - 根据艾宾浩斯/自定义记忆曲线更新下一次复习时间

### 5. 文章/段落/句子朗读（TTS）

- 在阅读器中增加音频播放功能：
  - 按整篇文章播放
  - 按段落播放
  - 按句子播放
- 播放控制：
  - 播放 / 暂停 / 跳转下一句 / 上一句
  - （可选）调整语速
- 技术实现：
  - 将句子文本通过 TTS 服务转换为音频
  - 可对常用句子进行音频缓存，减少重复生成

### 6. 测试功能（基于文章中的单词）

- 根据文档中出现的单词和句子，自动生成练习题：
  - 句子填空：
    - 从原句中挖空目标单词，让用户填空
  - 组句/改写（配合 AI）：
    - 给出多个关键词（均来自文章）
    - 让用户造句
    - 使用 AI 进行语法检查和表达建议
- 记录测试结果，与 SRS 结合更新单词熟练度。

---

## 四、前端功能规划

### 技术选型（建议）

- 框架：Next.js + React + TypeScript
- 样式：Tailwind CSS（可配合 shadcn/ui 组件库）
- 状态管理：Zustand（轻量，适合阅读器交互）
- 请求：Fetch / Axios

### 主要页面与组件

1. 认证相关
   - 登录 / 注册 / 忘记密码页面

2. 文档管理
   - 文档列表页：展示用户已导入的 PDF/Word 文档
   - 文档导入页：
     - 文件上传
     - 解析进度展示
     - 简单内容预览

3. 阅读器页面（核心）
   - 显示文章内容（分段、分句）
   - 单词点击高亮与词卡弹出
   - 收藏按钮（加入/移除生词本）
   - 音频控制条（整篇）
   - 句子旁的 TTS 播放控件

4. 生词本页面
   - 生词列表：
     - 单词、释义、例句、状态
   - 筛选：
     - 按状态（新词/学习中/已掌握）
     - 按来源文档
   - 点击单词查看详情和练习入口（造句/复习）

5. SRS 复习页面
   - 今日待复习的单词列表
   - 卡片式复习界面：
     - 展示提示（词或释义）
     - 用户自测后点击显示答案
     - 选择记忆程度（如：记得很好/模糊/完全忘记）

6. 造句与纠错页面/弹窗
   - 选中目标单词
   - 选择场景或输入场景描述
   - 用户输入自定义句子
   - 展示 AI 反馈：
     - 是否正确
     - 修改建议
     - 更地道表达

7. 测试练习页面
   - 填空题/组句题界面
   - 显示答题结果与解析

---

## 五、后端功能规划

### 技术选型（建议）

- 语言：Node.js + TypeScript
- 框架：NestJS
- 数据库：PostgreSQL
- ORM：Prisma
- 缓存：Redis（词典结果缓存、TTS 结果缓存、SRS 列表缓存）
- 存储：对象存储（用于保存原始 PDF/Word 文件和生成的音频文件）

### 核心模块

1. 认证模块（Auth）
   - 用户注册、登录、登出
   - JWT 认证与刷新
   - 基本权限控制

2. 文档模块（Document）
   - 文件上传（PDF/Word）
   - 文档解析：
     - PDF：使用 PDF 解析库提取文本
     - Word：使用 docx 解析库提取文本
   - 内容落库：
     - documents 文档表
     - document_paragraphs 段落表
     - document_sentences 句子表

3. 词汇与生词模块（Vocabulary）
   - 查询单词信息（调用外部词典 API + 缓存）
   - 用户生词本管理：
     - 添加/删除单词
     - 更新单词状态（新词/学习中/已掌握）
   - 和文章内容的关联（标记词汇来自哪篇文章）

4. 造句与纠错模块（AI Writing）
   - 接收目标单词、场景、用户句子
   - 调用大模型 API：
     - 输出结构化结果（JSON），包括：
       - 是否正确
       - 修正句子
       - 更地道版本
       - 错误类型说明
   - 保存造句记录和 AI 反馈

5. 复习（SRS）模块
   - 根据“艾宾浩斯曲线/间隔重复算法”为每个用户-单词计算下一次复习时间
   - 每次复习后更新：
     - 熟练度
     - 上次复习时间
     - 下一次复习时间
   - 提供“今日待复习单词”查询接口

6. TTS 模块
   - 接收文本（句子/段落/文章）与语音参数
   - 调用 TTS 服务生成音频
   - 将生成结果（URL、时长、文本哈希）缓存和持久化
   - 提供音频地址给前端播放器使用

7. 测试模块
   - 基于文章内容生成题目：
     - 填空题（从句子挖空目标单词）
     - 造句/组句题（可结合 AI 构造更复杂题目）
   - 记录用户做题结果
   - 可选：影响 SRS 的单词熟练度

---

## 六、数据模型概览（简化）

> 仅为概念级，具体字段在设计数据库 Schema 时细化。

- users
- documents
- document_paragraphs
- document_sentences
- user_words
- word_definitions（可选，或仅缓存外部词典）
- srs_reviews
- ai_sentence_tasks
- ai_sentence_results
- tts_assets
- test_exercises
- test_results

---

## 七、后续工作建议

1. 确认上面的功能范围是否覆盖你的 V1 目标。
2. 选定实际要使用的：
   - 大模型服务（OpenAI / Anthropic / 国内模型等）
   - TTS 服务（云 TTS / Edge TTS 等）
3. 进入数据库 Schema 设计与后端 API 详细设计阶段。
4. 搭建基础项目结构（前端 + 后端），逐步实现：
   - 文档导入 → 阅读器 → 生词本 → 造句与 SRS → TTS 与测试。
