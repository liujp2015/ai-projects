# 返利折扣网系统 - 需求文档

## 1. 项目概述

构建一个返利折扣网系统，类似淘宝客，支持资源国际化。系统包含后台管理系统、前台 PC 端和 API 服务端。

## 2. 技术栈要求

### 2.1 后台管理系统

- 框架：UmiJS

### 2.2 前台 PC 端

- 框架：Next.js
- 样式：Tailwind CSS
- 语言：TypeScript

### 2.3 后端服务

- 框架：NestJS
- 数据库：PostgreSQL
- ORM：Prisma
- 缓存/队列：Redis
- API 风格：RESTful API

## 3. 功能需求

### 3.1 商品管理

#### 3.1.1 功能描述

商品可以从购物网站的营销推广中获取，也可以手动创建。最重要的字段是 `link`，点击"去购买"跳转到真实的购物网站。

#### 3.1.2 功能列表

- 商品列表查询
- 添加商品
- 修改商品
- 删除商品
- 推送功能（调用 NestJS 的 API 接口添加到 Redis 的队列，消费队列向 WebSocket 在线用户推送商品信息）

#### 3.1.3 商品字段

- `id`: UUID
- `title`: 标题
- `description`: 描述
- `originalPrice`: 原价
- `discountPrice`: 当前折扣价
- `link`: 跳转链接（最重要字段）
- `isHidden`: 是否隐藏
- `storageId`: 存储 ID
- `brandId`: 品牌 ID
- `categoryId`: 分类 ID
- `platform`: 购物平台来源
- `keywords`: 关键字
- `sortOrder`: 自定义顺序（首页展示列表排序）
- `isTop`: 是否置顶（首页展示列表排序）
- `createdAt`: 创建时间
- `endTime`: 结束时间
- `updatedAt`: 更新时间

### 3.2 品牌管理

#### 3.2.1 功能描述

管理商品品牌，添加商品时可以选择品牌。

#### 3.2.2 功能列表

- 品牌列表查询
- 添加品牌
- 修改品牌
- 删除品牌

### 3.3 商品分类管理

#### 3.3.1 功能描述

对商品进行分类管理，在新建商品时可以选择分类。

#### 3.3.2 功能列表

- 分类列表查询
- 添加分类
- 修改分类
- 删除分类

### 3.4 权限管理

#### 3.4.1 功能描述

对系统所有模块进行权限控制。

#### 3.4.2 功能列表

对所有模块进行：

- 查询权限
- 添加权限
- 修改权限
- 删除权限

### 3.5 角色管理

#### 3.5.1 功能描述

管理系统角色，为角色分配权限。

#### 3.5.2 功能列表

- 角色列表查询
- 添加角色
- 修改角色
- 删除角色
- 权限分配给角色

### 3.6 用户管理

#### 3.6.1 功能描述

管理系统用户，包括后台管理员和前台注册用户。

#### 3.6.2 功能列表

- 用户列表查询
- 修改用户
- 删除用户
- 为用户分配角色（选择角色）

#### 3.6.3 业务规则

- 在 PC 前端注册的用户默认没有角色
- 默认一个 admin 管理员拥有所有权限

### 3.7 存储管理

#### 3.7.1 功能描述

管理第三方云存储配置，包括存储地址、API Key、Security Key 等信息。

#### 3.7.2 功能列表

- 存储配置列表查询
- 添加存储配置
- 修改存储配置
- 删除存储配置

#### 3.7.3 存储字段

- 存储地址
- API Key
- Security Key
- 其他配置信息

### 3.8 订单管理

#### 3.8.1 功能描述

管理从购物平台同步过来的订单。

#### 3.8.2 功能列表

- 订单列表查询
- 订单下载

### 3.9 Banner 图管理

#### 3.9.1 功能描述

管理网站前端的 Banner 图区域，配置轮播图。

#### 3.9.2 功能列表

- Banner 列表查询
- 添加 Banner
- 修改 Banner
- 删除 Banner
- 轮播图顺序管理

### 3.10 网站配置

#### 3.10.1 功能描述

管理系统全局配置，包括积分规则等。

#### 3.10.2 配置项

- 注册赠送积分数量
- 订单成功后赠送积分数量

#### 3.10.3 数据要求

- 用户表需要记录：
  - `totalPoints`: 总积分
  - `remainingPoints`: 剩余积分
- 需要积分表记录用户的积分增加和减少情况

## 4. 前台 PC 端功能需求

### 4.1 登录注册

#### 4.1.1 登录功能

- 用户名/邮箱登录
- 密码登录
- Remember me 功能（一周有效期）
- 忘记密码功能

#### 4.1.2 注册功能

- 邮箱验证码注册
- 注册成功后赠送积分（根据网站配置）

### 4.2 首页

#### 4.2.1 搜索功能

- 搜索框支持搜索：
  - 商品
  - 分类
  - 品牌
- 条件查询（通过选择框）

#### 4.2.2 Banner 图展示

- 展示后台设置的 Banner 图
- 轮播展示

#### 4.2.3 商品列表

- 分页展示商品列表
- 支持排序（自定义顺序、置顶）

### 4.3 商品详情页

#### 4.3.1 商品信息展示

- 商品详细信息
- 原价、折扣价
- "去购买"按钮（跳转到 link）

#### 4.3.2 推荐商品

- 展示其他推荐商品列表
- 自动滚动，像轮播图一样

### 4.4 个人中心

#### 4.4.1 功能描述

用户个人中心，用户可以查看和修改个人信息，查看订单记录。

#### 4.4.2 功能列表

- 查看个人信息（积分、余额、头像、昵称等）
- 修改昵称
- 修改头像
- 查看订单列表（分页）

#### 4.4.3 订单关联规则

- 订单通过 `clickId` 和购物平台的订单号进行关联
- 用户点击商品跳转到购物平台时，系统生成 `clickId`
- 购物平台回调订单信息时，通过 `clickId` 关联到用户

### 4.5 WebSocket 连接

#### 4.5.1 连接要求

- Next.js 需要使用 WebSocket 与后端的 NestJS 连接
- 用户登录后把 token 存在 `user_access_tokens`
- 通过 `user_refresh_tokens` 确定在线用户
- 向在线用户发送要推送的商品

#### 4.5.2 连接流程

- 用户进入首页登录后需要使用 WebSocket 连接到 NestJS 的 WebSocket
- 发送 token 进行身份验证

## 5. 后端 API 需求

### 5.1 技术栈

- 框架：NestJS
- 数据库：PostgreSQL
- ORM：Prisma
- 缓存/队列：Redis
- API 风格：RESTful API

### 5.2 核心功能

#### 5.2.1 Redis 队列

- 使用 Redis 的订阅模式订阅商品推送列表
- 商品推送时，将推送任务添加到 Redis 队列
- 消费队列，向在线用户推送商品信息

#### 5.2.2 WebSocket 服务

- 使用 WebSocket 与 Next.js 在线的用户连接
- 接收客户端 token 进行身份验证
- 向在线用户推送商品信息

#### 5.2.3 数据模型

- 使用 Prisma 操作 PostgreSQL 数据库
- 定义所有业务模型和关系

## 6. 数据库需求

### 6.1 数据库类型

- PostgreSQL

### 6.2 主要数据表

- 用户表（包含积分字段、昵称、头像）
- 积分记录表
- 商品表
- 品牌表
- 分类表
- 订单表（包含 clickId 字段）
- Banner 表
- 存储配置表
- 权限表
- 角色表
- 角色权限关联表
- 用户角色关联表
- Token 表（user_access_tokens, user_refresh_tokens）

## 7. 非功能性需求

### 7.1 性能要求

- 支持分页查询
- 商品列表支持排序
- WebSocket 推送需要高效处理

### 7.2 安全要求

- Token 认证机制
- 权限控制
- 角色管理

### 7.3 国际化支持

- 系统需要支持资源国际化

## 8. 接口需求

### 8.1 RESTful API

- 提供标准的 RESTful API 接口
- 支持 CRUD 操作
- 统一的响应格式

### 8.2 WebSocket 接口

- 商品推送接口
- 用户在线状态管理
